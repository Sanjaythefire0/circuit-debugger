<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>VR Circuit Debugger - AFrame Version</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        body {
            margin: 0;
        }
    </style>

</head>

<body>

    <a-scene background="color: #050505">

        <!-- ===================================== -->
        <!-- PLAYER RIG (HEAD + CONTROLLERS)      -->
        <!-- ===================================== -->

        <a-entity id="rig" movement-controls="speed: 0.15">

            <!-- CAMERA (Your head) -->
            <a-entity camera position="0 1.6 5" look-controls>
            </a-entity>

            <!-- LEFT HAND -->
            <a-entity id="leftController" meta-touch-controls="hand: left" laser-controls="hand: left"
                raycaster="objects: .clickable; far: 20" line="color: cyan">
            </a-entity>

            <!-- RIGHT HAND -->
            <a-entity id="rightController" meta-touch-controls="hand: right" laser-controls="hand: right"
                raycaster="objects: .clickable; far: 20" line="color: magenta">
            </a-entity>

        </a-entity>

        <!-- ===================================== -->
        <!-- GROUND -->
        <!-- ===================================== -->

        <a-plane rotation="-90 0 0" width="50" height="50" color="#111">
        </a-plane>

        <!-- ===================================== -->
        <!-- LIGHTING -->
        <!-- ===================================== -->

        <a-light type="ambient" intensity="0.6"></a-light>

        <a-light type="directional" position="5 10 5" intensity="1">
        </a-light>

        <!-- ===================================== -->
        <!-- CIRCUIT OBJECTS -->
        <!-- ===================================== -->

        <!-- Wire -->
        <a-cylinder id="wire" class="clickable" position="0 1 -3" rotation="0 0 90" radius="0.05" height="10"
            color="#004400">
        </a-cylinder>

        <!-- Resistor -->
        <a-cylinder class="clickable" position="-3 1 -3" rotation="0 0 90" radius="0.2" height="1" color="#D2B48C">
        </a-cylinder>

        <!-- Capacitor -->
        <a-cylinder class="clickable" position="-1 1 -3" radius="0.3" height="0.8" color="#1034A6">
        </a-cylinder>

        <!-- IC Chip -->
        <a-box class="clickable" position="1 1 -3" depth="0.8" height="0.3" width="1.2" color="#111">
        </a-box>

        <!-- LED -->
        <a-sphere id="led-sphere" class="clickable" position="3 1 -3" radius="0.3" color="#ff0000" emissive="#ff0000">
        </a-sphere>

        <!-- Signal Pulse -->
        <a-sphere id="pulse" position="-4 1 -3" radius="0.15" color="#00ffff" emissive="#00ffff">
        </a-sphere>

        <!-- ===================================== -->
        <!-- SKY -->
        <!-- ===================================== -->

        <a-sky color="#050505"></a-sky>

    </a-scene>

    <!-- ===================================== -->
    <!-- MOVEMENT COMPONENT -->
    <!-- ===================================== -->


    <!-- ===================================== -->
    <!-- UI OVERLAY -->
    <!-- ===================================== -->
    <div id="ui"
        style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 300px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white; display: flex; flex-direction: column; gap: 5px; z-index: 100;">
        <button id="playBtn"
            style="background: lime; border: none; padding: 5px; cursor: pointer; font-weight: bold;">PLAY</button>
        <input type="range" id="slider" min="0" max="9" step="0.01" value="0">
        <div id="timeText" style="text-align: right; font-family: monospace;">T: 0.00</div>
    </div>

    <!-- ===================================== -->
    <!-- LOGIC -->
    <!-- ===================================== -->

    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <script>
        AFRAME.registerComponent('signal-debug', {
            schema: {
                playbackSpeed: { type: 'number', default: 2.0 }
            },
            init: function () {
                // Config
                this.signalData = [
                    { time: 0, position: -4, fault: false },
                    { time: 2, position: -2, fault: false },
                    { time: 4, position: 0, fault: false },
                    { time: 5, position: 0, fault: true },
                    { time: 7, position: 2, fault: true },
                    { time: 9, position: 4, fault: false }
                ];
                this.MAX_TIME = 9;

                // State
                this.time = 0;
                this.isPlaying = false;

                // References
                this.pulse = document.querySelector('#pulse');
                this.wire = document.querySelector('#wire');
                this.led = document.querySelector('#led-sphere');

                // UI
                this.slider = document.querySelector('#slider');
                this.playBtn = document.querySelector('#playBtn');
                this.timeText = document.querySelector('#timeText');

                // Events
                this.playBtn.addEventListener('click', () => {
                    this.isPlaying = !this.isPlaying;
                    this.playBtn.innerText = this.isPlaying ? "PAUSE" : "PLAY";
                });

                this.slider.addEventListener('input', (e) => {
                    this.time = parseFloat(e.target.value);
                    this.isPlaying = false; // Pause when scrubbing
                    this.playBtn.innerText = "PLAY";
                    this.updateScene(this.time);
                });
            },

            tick: function (t, dt) {
                if (this.isPlaying) {
                    this.time += (dt / 1000) * this.data.playbackSpeed;
                    if (this.time > this.MAX_TIME) this.time = 0;

                    // Update UI
                    this.slider.value = this.time;
                    this.timeText.innerText = "T: " + this.time.toFixed(2);

                    this.updateScene(this.time);
                }
            },

            updateScene: function (time) {
                const signal = this.getSignal(time);

                // Update Pulse Position
                if (this.pulse) {
                    this.pulse.object3D.position.x = signal.position;
                    // Pulse wobble (using standard Three.js math)
                    this.pulse.object3D.position.y = 1 + Math.sin(time * 5) * 0.05;
                }

                // Update Wire Color (Fault detection)
                if (this.wire) {
                    if (signal.fault) {
                        this.wire.setAttribute('color', '#ff0000');
                    } else {
                        this.wire.setAttribute('color', '#004400');
                    }
                }

                // Update LED Intensity
                if (this.led) {
                    if (signal.fault) {
                        this.led.setAttribute('emissive-intensity', 2.0);
                    } else {
                        this.led.setAttribute('emissive-intensity', 0.1);
                    }
                }
            },

            getSignal: function (time) {
                const t = Math.max(0, Math.min(time, this.MAX_TIME));
                let idx = 0;
                while (idx < this.signalData.length - 1 && this.signalData[idx + 1].time < t) idx++;

                const p0 = this.signalData[idx];
                const p1 = this.signalData[idx + 1];
                if (!p1) return p0;

                const alpha = (t - p0.time) / (p1.time - p0.time);

                const position = p0.position + (p1.position - p0.position) * alpha;
                const isFault = p0.fault || (p1.fault && alpha > 0.5);

                return { position, fault: isFault };
            }
        });

        // Attach component to scene
        document.querySelector('a-scene').setAttribute('signal-debug', '');
    </script>
</body>

</html>
